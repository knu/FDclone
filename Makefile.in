#
#	Makefile for fd
#

TITLE	= FD-
BINDIR	= /usr/local/bin
MANDIR	= /usr/local/man/man$(MANSEC)
DEFRC	= /etc/fdrc
SHELL	= /bin/sh
INSTALL	= cp
MANSEC	= 1

SRC	= main.c term.c pathname.c libc.c input.c shell.c info.c\
	kanji.c file.c apply.c archive.c tree.c command.c browse.c\
	kanjicnv.c mkfuncno.c expfunc.c
HEADER	= fd.h machine.h types.h kctype.h term.h pathname.h\
	func.h functable.h

DOC	= README HISTORY FAQ TECHKNOW Install
MANSRC	= fd.man
MANSEC	= 1
RUNCOM	= .fdrc

SOURCES	= $(DOC) NoExecMe Makefile Makefile.in $(MANSRC) $(SRC) $(HEADER)\
	config.h.in kanji.h.in mkmf.sed.c version.h .fdrc

CC	= __CC__
SED	= sed
PROGRAM	= fd
OBJ	= main.o term.o pathname.o libc.o input.o shell.o info.o\
	kanji.o file.o apply.o archive.o tree.o command.o browse.o

LDFLAGS	= __TERMLIBS__ __REGLIBS__ __OTHERLIBS__
CFLAGS	= -DFD -DDEFRUNCOM=\"$(DEFRC)\" __CCOPTIONS__

############################################################
#	Dependency Rules
############################################################

goal:	$(PROGRAM) $(PROGRAM).$(MANSEC)

$(PROGRAM): $(OBJ)
	$(CC) $(CFLAGS) -o $(PROGRAM) $(OBJ) $(LDFLAGS)


############################################################
# kanji using module

kanji.h: kanjicnv kanji.h.in
	./kanjicnv kanji.h.in $@

$(PROGRAM).$(MANSEC): kanjicnv $(MANSRC)
	./kanjicnv $(MANSRC) $@

kanjicnv: kanjicnv.c
	$(CC) $(CFLAGS) -o $@ $@.c


############################################################
# function list using module

funcno.h: mkfuncno functable.h
	./mkfuncno functable.h $@

mkfuncno: mkfuncno.c
	$(CC) $(CFLAGS) -o $@ $@.c


############################################################
# to install all

install: $(PROGRAM) $(PROGRAM).$(MANSEC)
	$(INSTALL) $(PROGRAM) $(BINDIR)
	$(INSTALL) $(PROGRAM).$(MANSEC) $(MANDIR)/$(PROGRAM).$(MANSEC)
	-if [ -f $(RUNCOM) ]; then \
		$(INSTALL) $(RUNCOM) $(DEFRC); \
	fi


############################################################
# to make dependency

depend: $(SRC) kanji.h funcno.h
	mv Makefile.in Makefile.in.bak
	makedepend -s "# DO NOT DELETE THIS LINE -- make depend depends on it."\
		-f Makefile.tmp -- $(CFLAGS) -- $(SRC)
	rm -f Makefile.tmp.bak
	$(SED) -e "/^# DO NOT DELETE THIS LINE/,$$$$d" Makefile.in.bak\
		> Makefile.in
	echo "# DO NOT DELETE THIS LINE -- make depend depends on it."\
		>> Makefile.in
	$(SED) -e "1,/^# DO NOT DELETE THIS LINE/d"\
		-e "s/\/[^ ]* *//g"\
		-e "s/\(kanjicnv\).o/\1/g"\
		-e "/: *$$/d" Makefile.tmp >> Makefile.in
	rm -f Makefile.in.bak Makefile.tmp


############################################################
# to make configuration file manually

config: NoExecMe expfunc.c
	-if (echo 't() { echo $1; }; t test' | sh >/dev/null 2>&1) ; then \
		./NoExecMe > config.h; \
	else \
		if [ ! -f expfunc ]; then \
			$(CC) $(CFLAGS) -o expfunc expfunc.c; \
		fi; \
		./expfunc < NoExecMe | sh > config.h; \
	fi


############################################################
# for programer's maintenance

GETVER	= HEAD="`tail -1 version.h`";\
	VER=`expr "$$HEAD" : '.*\([0-9][0-9]*\.[0-9a-z]*\).*'`

tar: $(SOURCES)
	($(GETVER);\
	tar cvf $(TITLE)"$$VER".tar $(SOURCES);\
	compress -f $(TITLE)"$$VER".tar)

lzh: $(SOURCES)
	($(GETVER);\
	rm -f $(TITLE)"$$VER".lzh;\
	lha a $(TITLE)"$$VER".lzh $(SOURCES))

shar: $(SOURCES)
	($(GETVER);\
	rm -f $(TITLE)$$VER.shar.[0-9]0-9];\
	shar -L50 -ac -n $(TITLE)"$$VER" -o $(TITLE)"$$VER".shar $(SOURCES))

clean:
	rm -f core *.o funcno.h kanji.h kanjicnv mkfuncno expfunc \
	$(PROGRAM) $(PROGRAM).$(MANSEC)
# DO NOT DELETE THIS LINE -- make depend depends on it.

main.o: fd.h machine.h config.h 
main.o: types.h pathname.h term.h
main.o: func.h kctype.h
main.o: kanji.h funcno.h version.h 
term.o: machine.h
term.o: config.h term.h 
pathname.o: machine.h config.h pathname.h 
libc.o: fd.h machine.h config.h 
libc.o: types.h pathname.h term.h
libc.o: func.h kctype.h
libc.o: kanji.h 
input.o: fd.h machine.h config.h 
input.o: types.h pathname.h
input.o: term.h func.h 
input.o: kctype.h 
shell.o: fd.h machine.h config.h 
shell.o: types.h pathname.h
shell.o: term.h func.h 
shell.o: kanji.h
info.o: fd.h machine.h config.h 
info.o: types.h pathname.h term.h
info.o: funcno.h kanji.h 
kanji.o: fd.h machine.h config.h 
kanji.o: types.h pathname.h
kanji.o: term.h func.h 
kanji.o: kctype.h 
file.o: fd.h machine.h config.h 
file.o: types.h pathname.h term.h
file.o: func.h kanji.h
apply.o: fd.h machine.h config.h 
apply.o: types.h pathname.h
apply.o: term.h func.h 
apply.o: kanji.h 
archive.o: fd.h machine.h config.h 
archive.o: types.h pathname.h
archive.o: term.h func.h 
archive.o: funcno.h kanji.h 
tree.o: fd.h machine.h config.h 
tree.o: types.h pathname.h term.h
tree.o: func.h kanji.h
command.o: fd.h machine.h config.h 
command.o: types.h pathname.h
command.o: term.h func.h 
command.o: funcno.h kanji.h 
command.o: functable.h
browse.o: fd.h machine.h config.h 
browse.o: types.h pathname.h
browse.o: term.h func.h 
browse.o: funcno.h kanji.h 
kanjicnv: machine.h config.h
